---
service_name: "Firmware (ESP32)"
description: "生体センサーデータの計測、タイムスタンプ付与、圧縮、およびBLE経由での送信を行う組み込みソフトウェア。"
inputs:
  - source: "物理センサー (ADC, MPU6050)"
    data_format: "アナログ/デジタル信号"
    schema: "N/A"
  - source: "スマートフォンアプリ (BLE)"
    data_format: "BLE Write (Ping for Time Sync)"
    schema: "{ T1: uint64_t }"
outputs:
  - target: "スマートフォンアプリ (BLE)"
    data_format: "BLE Notify (Compressed Sensor Data)"
    schema: "Zstandard圧縮されたバイナリデータ"
  - target: "スマートフォンアプリ (BLE)"
    data_format: "BLE Notify (Pong for Time Sync)"
    schema: "{ T1: uint64_t, T2: uint64_t }"
---

## 概要

本ファームウェアは、脳波(EEG)および慣性(IMU)センサーからデータを高速にサンプリングし、デバイス自身の内部クロックでマイクロ秒精度のタイムスタンプを各サンプルに付与します。一定量のデータがバッファに溜まると、Zstandard アルゴリズムで高効率に圧縮し、BLE 経由で接続先のスマートフォンアプリに送信します。

また、スマートフォンアプリとの時刻同期のため、Ping-Pong メカニズムを実装します。

## 詳細

### データ収集と圧縮

- **責務**: 本ファームウェアの責務は、**「高品質なデータを、正確な相対時間情報と共に、可能な限り効率的に送信すること」**に限定されます。ユーザー ID、実験 ID、セッション ID といった概念は一切関知しません。
- **背景**: 組み込み環境のリソースは限られています。責務を限定することで、データ収集のリアルタイム性を最優先し、ソフトウェアの堅牢性を高めます。セッションなどのメタ情報は、より強力なリソースを持つ上位のアプリケーション（スマホ、サーバー）が管理するべきです。
- **データ構造**: パケットにはデバイスを一意に識別するための MAC アドレスから生成された`device_id`が含まれます。
- **圧縮**: データは 0.5 秒分（`SAMPLE_RATE / 2`）など、一定サンプル数が溜まるごとに圧縮され、送信されます。これにより、リアルタイム性を損なうことなく、通信データ量を大幅に削減します。

### 時刻同期 (Ping-Pong メカニズム)

- **目的**: BLE 通信の遅延の「ゆらぎ」を乗り越え、スマートフォンとファームウェアのクロックのズレ（オフセット）を正確に計測するため。
- **処理フロー**:
  1.  スマホから現在の UNIX 時間 `T1` を含む Ping メッセージを受信する。
  2.  受信した瞬間に、自身の内部クロック時刻 `T2` を記録する。
  3.  即座に、受信した `T1` と記録した `T2` をペアにした Pong メッセージをスマホに返信する。
- **背景**: NTP のような標準的な時刻同期プロトコルが使えない BLE 環境において、アプリケーション層で実装できる最もシンプルかつ効果的な手法が往復時間(RTT)を利用したオフセット計算です。これにより、後段のサーバー側で全てのタイムスタンプを正確な UTC 時刻に補正することが可能になります。
