---

# サーバー受信データスキーマ仕様

## 1\. 概要

本仕様書は、クライアント（スマホアプリ）からサーバーへ送信される JSON ペイロード内の `payload_base64` フィールドをデコード・解凍した後に得られる、バイナリデータの構造を定義する。

- **外部 JSON 構造:**

  ```json
  {
    "user_id": "string",
    "session_id": "string | null",
    "device_id": "string",
    "timestamp_start_ms": "integer",
    "timestamp_end_ms": "integer",
    "payload_base64": "string"
  }
  ```

  - `session_id`はセッション中以外は `null` となる。

- **内部バイナリデータ:**

  - `payload_base64` は、以下の仕様で定義されるバイナリデータを **Zstandard** で圧縮し、**Base64** でエンコードしたものである。
  - データは、**単一のヘッダーブロック**と、それに続く**128 個のサンプルデータブロック**で構成される連続したバイナリ ストリームである。
  - 全ての数値は **リトルエンディアン** 形式とする。

---

## 2\. データ全体構造

ペイロード全体のレイアウトは以下の通り。

**[ヘッダーブロック] + ([サンプルデータブロック] x 128 回)**

---

## 3\. ヘッダーブロック仕様

ペイロードの先頭に 1 つだけ存在する固定長のブロック。このペイロードに含まれるデータの定義情報を持つ。

| フィールド名       | データ型     | サイズ(Bytes)        | 説明                                            |
| :----------------- | :----------- | :------------------- | :---------------------------------------------- |
| `version`          | `uint8_t`    | 1                    | このペイロード構造のバージョン。現行は `0x02`。 |
| `num_channels`     | `uint8_t`    | 1                    | チャンネルの総数。最大 24 まで。                |
| `reserved`         | `uint8_t[6]` | 6                    | 将来のための予約領域。`0x00` で埋める。         |
| `electrode_config` | `struct`配列 | `num_channels` \* 10 | 各電極の設定情報。詳細は下記参照。              |

#### `electrode_config` 構造体 (10 Bytes)

`num_channels` の数だけ繰り返される。

| フィールド名 | データ型  | サイズ(Bytes) | 説明                                                                       |
| :----------- | :-------- | :------------ | :------------------------------------------------------------------------- |
| `name`       | `char[8]` | 8             | 電極名 (例: "Fp1")。UTF-8 エンコード、未使用分は `\0` (ヌル文字)で埋める。 |
| `type`       | `uint8_t` | 1             | 電極タイプ。<br> `0`: EEG, `1`: EMG, `2`: EOG, `3`: TRIG, `255`: UNKNOWN   |
| `reserved`   | `uint8_t` | 1             | 予約領域。`0x00` で埋める。                                                |

---

## 4\. サンプルデータブロック仕様

ヘッダーブロックの直後から、1 サンプル分のデータブロックが 128 回繰り返される。
ブロックの合計サイズは `(num_channels * 3) + 12` Bytes となる。

| フィールド名 | データ型                                  | サイズ(Bytes)       | 説明                                                                   |
| :----------- | :---------------------------------------- | :------------------ | :--------------------------------------------------------------------- |
| `signals`    | `uint16_t`配列, muse の場合`uint12_t`配列 | `num_channels` \* 2 | 全チャンネルの信号値 (0-4095)。`electrode_config`の順序に対応する。    |
| `accel`      | `int16_t[3]`                              | 6                   | 加速度 (X, Y, Z)。                                                     |
| `gyro`       | `int16_t[3]`                              | 6                   | ジャイロ (X, Y, Z)。                                                   |
| `impedance`  | `uint8_t`配列                             | `num_channels`      | 全チャンネルのインピーダンス。<br> `0`: Good, `1`: Bad, `255`: UNKNOWN |

#### `signals` フィールドの特別仕様

- 信号値は 12bit (0-4095) を想定。
- `electrode_config` の `type` が `TRIG` **以外**のチャンネルにおいて、`bit 12` (13 番目のビット) は汎用的なトリガーフラグとして使用されることがある。
  - `(value & 0x1000) != 0` であれば、そのサンプルで外部トリガーが ON になったことを示す。

---

## 5\. デバイス別データマッピングと Optional 項目

Muse 2 接続時は、スマホアプリが同じバイナリ構造を維持するため、取得できないデータを「無効値」で埋める。

| フィールド         | 自作脳波計 (8-24ch)      | Muse 2 (4ch)                                                                                  |
| :----------------- | :----------------------- | :-------------------------------------------------------------------------------------------- |
| **ヘッダー**       |                          |                                                                                               |
| `num_channels`     | マイコンから受信 (8-24)  | **固定値: `4`**                                                                               |
| `electrode_config` | マイコンから受信した設定 | **アプリが生成する固定設定:**<br> `[{"TP9", EEG}, {"AF7", EEG}, {"AF8", EEG}, {"TP10", EEG}]` |
| **サンプルデータ** |                          |                                                                                               |
| `signals`          | 8-24 ch 分のデータ       | 4 ch 分のデータ                                                                               |
| `accel`            | あり                     | あり                                                                                          |
| `gyro`             | あり                     | あり                                                                                          |
| `impedance`        | `0` (Good) or `1` (Bad)  | **【Optional】常に無効値 `255` (UNKNOWN) で埋められる**                                       |

---

## 6\. バイナリデータ例 (ペイロードの先頭部分)

#### 例 1: 自作脳波計 (8ch) の場合

- **Header (88 bytes)** + **Sample[0] (36 bytes)** + ...

<!-- end list -->

```
// Header Block
02                                     // version: 2
08                                     // num_channels: 8
00 00 00 00 00 00                      // reserved
// electrode_config[0] ("Fp1", EEG)
46 70 31 00 00 00 00 00 00 00
// electrode_config[1] ("Fp2", EEG)
46 70 32 00 00 00 00 00 00 00
... (残り6ch分続く) ...

// Sample Data Block [0]
B5 07 E7 07 ED 07 1D 08 ... (16 bytes for signals)
10 00 20 00 C8 F8          // accel[3]
F5 01 A5 FF 32 00          // gyro[3]
00 00 01 00 01 00 00 00    // impedance[8]

// Sample Data Block [1]
... (36 bytes) ...
```

#### 例 2: Muse 2 (4ch) の場合

- **Header (48 bytes)** + **Sample[0] (28 bytes)** + ...

<!-- end list -->

```
// Header Block
02                                     // version: 2
04                                     // num_channels: 4
00 00 00 00 00 00                      // reserved
// electrode_config[0] ("TP9", EEG)
54 50 39 00 00 00 00 00 00 00
// electrode_config[1] ("AF7", EEG)
41 46 37 00 00 00 00 00 00 00
... (残り2ch分続く) ...

// Sample Data Block [0]
B5 07 E7 07 ED 07 1D 08    // 8 bytes for signals[4]
10 00 20 00 C8 F8          // accel[3]
F5 01 A5 FF 32 00          // gyro[3]
FF FF FF FF                // impedance[4] - 全て無効値

// Sample Data Block [1]
... (28 bytes) ...
```
