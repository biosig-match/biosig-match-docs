````markdown
# サーバー受信データスキーマ仕様

## 1. 概要
本仕様書は、クライアント（スマホアプリ）からサーバーへ送信される JSON ペイロード内の `payload_base64` フィールドをデコード・解凍した後に得られる、バイナリデータの構造を定義する。

**外部 JSON 構造:**

```json
{
  "user_id": "string",
  "session_id": "string | null",
  "device_id": "string",
  "timestamp_start_ms": "integer",
  "timestamp_end_ms": "integer",
  "payload_base64": "string"
}
````

**内部バイナリデータ:**
`payload_base64` は、以下の仕様で定義されるバイナリデータを Zstandard で圧縮し、Base64 でエンコードしたものである。
データは、単一のヘッダーブロックと、それに続く250 個のサンプルデータブロックで構成される連続したバイナリ ストリームである。
全ての数値は **リトルエンディアン** 形式とする。

-----

## 2\. データ全体構造

ペイロード全体のレイアウトは以下の通り。

`[ヘッダーブロック] + ([サンプルデータブロック] x 250 回)`

-----

## 3\. ヘッダーブロック仕様

ペイロードの先頭に 1 つだけ存在するブロック。このペイロードに含まれるデータの物理的な定義情報を持つ。

| フィールド名         | データ型       | サイズ(Bytes)        | 説明                                                         |
| -------------------- | -------------- | -------------------- | ------------------------------------------------------------ |
| `version`            | `uint8_t`      | 1                    | このペイロード構造のバージョン。現行は `0x03`。                 |
| `num_channels`       | `uint8_t`      | 1                    | チャンネルの総数 (例: 自作脳波計: 9, Muse 2: 4)。           |
| `sampling_rate`      | `float32`      | 4                    | サンプリングレート (Hz)。リトルエンディアン。                |
| `lsb_to_volts`       | `float32`      | 4                    | ADCの1LSBあたりの電圧(V)への変換係数。リトルエンディアン。     |
| `reserved`           | `uint8_t[2]`   | 2                    | 将来のための予約領域。`0x00` で埋める。                      |
| `electrode_config`   | `struct`配列   | `num_channels` \* 10  | 各電極の設定情報。詳細は下記参照。                           |

#### `electrode_config` 構造体 (10 Bytes)

`num_channels` の数だけ繰り返される。

| フィールド名 | データ型     | サイズ(Bytes) | 説明                                                         |
| ------------ | ------------ | ------------- | ------------------------------------------------------------ |
| `name`       | `char[8]`    | 8             | 電極名 (例: `"CH1"`, `"TP9"`)。UTF-8、未使用分は `\0`。      |
| `type`       | `uint8_t`    | 1             | 電極タイプ。<br> `0`: EEG, `1`: EMG, `2`: EOG, `3`: TRIG, `255`: UNKNOWN |
| `reserved`   | `uint8_t`    | 1             | 予約領域。`0x00` で埋める。                                  |

-----

## 4\. サンプルデータブロック仕様

ヘッダーブロックの直後から、1 サンプル分のデータブロックが 250 回繰り返される。

| フィールド名   | データ型        | サイズ(Bytes)       | 説明                                                         |
| -------------- | --------------- | ------------------- | ------------------------------------------------------------ |
| `signals`      | `int16_t`配列   | `num_channels` \* 2  | 全チャンネルの信号値 (ADC raw value)。                       |
| `accel`        | `int16_t[3]`    | 6                   | 加速度 (X, Y, Z)。常に `0x00` で埋められる。                  |
| `gyro`         | `int16_t[3]`    | 6                   | ジャイロ (X, Y, Z)。常に `0x00` で埋められる。                |
| `impedance`    | `uint8_t`配列   | `num_channels`      | 全チャンネルのインピーダンス。常に `255` (UNKNOWN) で埋められる。 |

-----

## 5\. デバイス別データマッピング例

| フィールド           | 自作脳波計                               | Muse 2 (4ch)                                |
| -------------------- | ---------------------------------------- | ------------------------------------------- |
| **ヘッダー** |                                          |                                             |
| `num_channels`       | 9                                        | 4                                           |
| `sampling_rate`      | 250.0                                    | 256.0                                       |
| `lsb_to_volts`       | 5.722e-7 (Vref=4.5V, Gain=24)            | 4.8828125e-7 (1LSB=0.488...uV)              |
| `electrode_config`   | 8ch設定 + `{"TRIG", type:3}`             | `[{"TP9",0}, {"AF7",0}, ...]`                |
| **サンプルデータ** |                                          |                                             |
| `signals`            | 8ch EEG + 1ch Trigger (`int16_t`)        | 4ch EEG (`int16_t`, 12bit値を格納)          |

```
```
