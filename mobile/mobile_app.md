---
service_name: "Smartphone App"
description: "ユーザーインターフェースを提供し、ファームウェアとサーバー群を繋ぐ中継ハブ。ユーザー認証、セッション管理、データ中継の役割を担う。"

inputs:
  - source: "ファームウェア (BLE)"
    data_format: "BLE Notify (Compressed Sensor Data)"
    schema: "Zstandard圧縮されたバイナリデータ"
  - source: "ユーザー"
    data_format: "UI操作"
    schema: "ログイン、実験の作成/選択、セッション開始/終了、イベントファイル選択など"
  - source: "内蔵マイク・カメラ"
    data_format: "音声(WAVなど), 画像(JPEGなど)"
    schema: "セッション中に定期的にキャプチャされるメディアデータ"

outputs:
  - target: "Collectorサービス"
    data_format: "HTTP POST (JSON)"
    schema: "エンドポイント `/api/v1/data`: { user_id, payload_base64 }"
  - target: "Collectorサービス"
    data_format: "HTTP POST (Multipart/form-data)"
    schema: "エンドポイント `/api/v1/media`: フォームパートにメディアファイルとメタデータ { user_id, session_id }"
  - target: "Session Managerサービス"
    data_format: "HTTP POST/GET (JSON), HTTP POST (Multipart/form-data)"
    schema: "実験作成・選択リクエスト、セッション終了通知（メタデータ＋イベントCSV）"
  - target: "Realtime Analyzerサービス"
    data_format: "HTTP GET (JSON)"
    schema: "自身のユーザーIDに紐づく解析結果の要求"
---

## 概要

本アプリは、ユーザーが実験やセッションを管理するための UI を提供します。BLE 経由でセンサーデータを受け取り`Collector`に常時転送する一方、セッション中には内蔵マイク・カメラから取得したメディアデータも定期的にアップロードします。

## 詳細

### データ中継

- **責務**: センサーデータとメディアデータを、それぞれの特性に合った形式でサーバーへ継続的に送信する。
- **処理フロー**:
  - **センサーデータ**:
    1. BLE で受信した圧縮バイナリを Base64 エンコードする。
    2. `user_id`と共に JSON (`{ user_id, payload_base64 }`) を作成し、`/api/v1/data`へ常時送信する。
  - **メディアデータ (セッション中のみ)**:
    1. 10 秒ごとに音声を録音し、5 秒経過時点で写真を撮影する。
    2. 可能であれば各データを`zstandard`で圧縮する。
    3. `user_id`、`session_id`と共に`Multipart/form-data`形式で`/api/v1/media`へ送信する。

### セッション管理

- **責務**: `Session Manager`と連携し、実験選択からセッション完了までのライフサイクルを管理する。
- **処理フロー**:
  1. **実験選択**: ユーザーは UI 上で参加する実験を選択する（または新規作成する）。
  2. **セッション ID 生成**: セッション**作成時**（開始ボタンを押す前）に、クライアントサイドでセッション ID を生成する。命名規則は`{user_id}-{creation_unix_ms}`とする。
  3. **セッション開始**: ユーザーが UI でセッションタイプ（キャリブレーション／本計測）を選択すると計測が開始される。
  4. **デバイス ID の取得**: セッション開始後、アプリはリアルタイム描画のために解凍した最初のデータパケットからデバイス ID（MAC アドレスなど）を読み取り、現在のセッション情報として内部的に保持する。
  5. **セッション終了**: ユーザーが計測を終了すると、セッション終了画面へ遷移する。
  6. **完了処理**: ユーザーが（任意でイベント CSV を選択した後）「完了」ボタンを押すと、`Multipart/form-data`形式でセッションのメタデータ（**取得したデバイス ID を含む**）とイベント CSV を`/api/v1/sessions/end`へ送信する。

### 認証管理

- **責務**: (将来的実装) ユーザーの認証状態を管理し、各 Provider に`user_id`を提供します。
- **処理フロー**:
  1. ユーザーはログイン/登録を行う。
  2. 成功すると、アプリは認証トークンと`user_id`を安全に保持する。
  3. データ中継やセッション管理など、`user_id`を必要とする全ての処理は、この認証状態から`user_id`を取得する。
  4. 全てのサーバー API へのリクエストには、認証トークンをヘッダーに含める。

### ファームウェアとのタイムスタンプ同期

- **責務**: ファームウェアとのクロックのズレ（オフセット）を計算し、サーバーに提供する。
- **処理フロー**:
  1. BLE 接続後、定期的に（例: 1 分ごと）ファームウェアに対して Ping-Pong 処理を実行する。
  2. 往復時間(RTT)を利用してオフセットを計算する。
  3. 計算したオフセット値と、その計算が完了した時点の UNIX 時間をペアにして、`Processor`サービス（または専用エンドポイント）に送信する。
- **背景**: 正確なデータ同期のためには、収集されたデータのタイムスタンプを単一の信頼できるクロック（サーバーの UTC 時刻）に正規化する必要があります。この処理により、後段の`Processor`がその正規化を行うための補正情報を提供します。
