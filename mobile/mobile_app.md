---
service_name: "Smartphone App"
description: "ユーザーインターフェースを提供し、ファームウェアとサーバー群を繋ぐ中継ハブ。実験設計、セッション管理、データ中継の役割を担う。"

inputs:
  - source: "ファームウェア (BLE)"
    data_format: "BLE Notify (Compressed Sensor Data)"
    schema: "Zstandard圧縮されたバイナリデータ"
  - source: "ユーザー"
    data_format: "UI操作"
    schema: "ログイン、実験の作成/選択/設計、セッションモード選択、セッション開始/終了など"
  - source: "内蔵マイク・カメラ"
    data_format: "音声(WAVなど), 画像(JPEGなど)"
    schema: "セッション中に定期的にキャプチャされるメディアデータ"

outputs:
  - target: "Collectorサービス"
    data_format: "HTTP POST (JSON)"
    schema: "エンドポイント `/api/v1/data`: { user_id, payload_base64 }"
  - target: "Collectorサービス"
    data_format: "HTTP POST (Multipart/form-data)"
    schema: "エンドポイント `/api/v1/media`: { user_id, session_id } を含むメディアファイル"
  - target: "Session Managerサービス"
    data_format: "HTTP POST/GET (JSON), HTTP POST (Multipart/form-data)"
    schema: "実験作成リクエスト、刺激アセット登録、セッション終了通知"
---

## 概要

本アプリは、ユーザーが実験を「設計」し、セッションを「実行・管理」するためのUIを提供します。BLE経由でセンサーデータを常時転送する一方、実験のワークフローに応じて刺激アセットの登録や実績ログのアップロードを行います。

## 詳細

### 実験・セッション管理

- **責務**: `Session Manager`と連携し、実験の設計からセッション完了までのライフサイクル全体を管理する。
- **ワークフロー**:
  1. **実験作成/選択**: ユーザーは実験を作成または選択する。
  2. **セッションモード選択**:
     - ユーザーが「セッション開始」をタップすると、「アプリで刺激を提示（All-in-One）」か「外部アプリで刺激を提示（Hybrid）」かを選択するダイアログが表示される。
  3. **実験設計**:
     - 新規実験開始時、ユーザーはアプリ内の「実験設計画面」から、画像を扱うか音声を扱うか選択する。
     - アプリからスマートフォンの画像フォルダあるいは音声フォルダを開きファイルを選択、アプリの UI でファイルを並び替えて提示順を決定するか、ランダムな提示順を有効化する。使用するファイル群を`/api/v1/experiments/{id}/stimuli`へアップロードする。
  4. **セッション開始**:
     - **All-in-Oneモード**: まず、ユーザーが選択した画像ではなく、サービス側が用意する画像または音声を用いたキャリブレーション用データ収集を行う。「この画像に注目してください」のような指示をアプリで提示し、ターゲット画像とノンターゲット画像に対する脳波データを集める。
     - キャリブレーション用セッションが終わったら、本タスク用のセッションとしてアプリが実験設計時に登録された刺激を提示し、同時に脳波を記録。イベントログはアプリ内部で自動生成される。数十分間はキャリブレーションなしで同じ実験のセッションを行えるようにする。
     - **Hybridモード**: ユーザーはPC上のPsychoPyなどで刺激を提示する。
     - アプリはセッションに関係なく行っている脳波の記録を継続。将来このアプリにはユーザーの日常シーンと脳波の関係を導く巨大なデータセットを作り出す責務があるため、セッション開始から終了まではスマホカメラあるいはスクリーンショットによる定期的な撮影と継続的な録音が開始される。将来的に生体信号とユーザーシーンの解釈をLLMエージェントによって行うなどし、生活水準向上のための別機能として完全に独立させる予定。
  5. **セッション終了**: ユーザーが計測を終了すると、セッション終了画面へ遷移する。
  6. **完了処理**:
     - **All-in-Oneモード**: アプリが自動生成したイベントログcsvとセッションメタデータを`/api/v1/sessions/end`へ送信する。
     - **Hybridモード**: ユーザーは**PsychoPyなどが出力したイベントログCSV**をファイル選択し、アプリがセッションメタデータと共に`/api/v1/sessions/end`へ送信する。
     - セッション中に撮影した画像と録音した音声は collector へアップロードする。
